---
import Layout from '../layouts/Layout.astro';
import CartStore from '../components/CartStore.astro';
---

<Layout>
  <CartStore />
  <div class="checkout-container">
    <h1>Finalizar Pedido</h1>
    
    <!-- Resumen del pedido -->
    <div class="order-summary">
      <h2>Resumen del Pedido</h2>
      <div id="summary-items" class="summary-items">
        <!-- Se llena con JS -->
      </div>
    </div>

    <!-- Formulario de datos -->
    <div class="checkout-form">
      <h2>Datos de Entrega</h2>
      <form id="checkout-form">
        <div class="form-group">
          <label for="customer-name">Nombre y Apellido *</label>
          <input 
            type="text" 
            id="customer-name" 
            name="customerName" 
            placeholder="Ej: Juan P√©rez"
            required
          />
        </div>

        <div class="form-group">
          <label for="delivery-zone">Zona de Delivery *</label>
          <select id="delivery-zone" name="deliveryZone" required>
            <option value="">Selecciona tu zona</option>
            <!-- Se llena con JS -->
          </select>
        </div>

        <div class="form-group">
          <label for="notes">Notas adicionales (opcional)</label>
          <textarea 
            id="notes" 
            name="notes" 
            placeholder="Indicaciones especiales, alergias, etc."
            rows="3"
          ></textarea>
        </div>
      </form>
    </div>

    <!-- Resumen de costos -->
    <div class="cost-summary">
      <div class="summary-row">
        <span>Subtotal:</span>
        <span id="cost-subtotal">S/. 0.00</span>
      </div>
      <div class="summary-row">
        <span>Delivery:</span>
        <span id="cost-delivery">S/. 0.00</span>
      </div>
      <div class="summary-row">
        <span>Pedido M√≠nimo:</span>
        <span id="min-order-info">-</span>
      </div>
      <div class="summary-row total">
        <span>Total a Pagar:</span>
        <span id="cost-total">S/. 0.00</span>
      </div>

      <button type="button" id="send-whatsapp-btn" class="btn-whatsapp">
        <span>üì±</span> Enviar Pedido por WhatsApp
      </button>
      
      <a href="/cart" class="btn-back">‚Üê Volver al Carrito</a>
    </div>
  </div>
</Layout>

<script is:inline>
  let deliveryZones = [];
  let selectedZone = null;

  const summaryItemsEl = document.getElementById('summary-items');
  const deliveryZoneSelect = document.getElementById('delivery-zone');
  const costSubtotalEl = document.getElementById('cost-subtotal');
  const costDeliveryEl = document.getElementById('cost-delivery');
  const minOrderInfoEl = document.getElementById('min-order-info');
  const costTotalEl = document.getElementById('cost-total');
  const sendWhatsAppBtn = document.getElementById('send-whatsapp-btn');
  const customerNameInput = document.getElementById('customer-name');
  const notesInput = document.getElementById('notes');

  // Verificar que haya items en el carrito
  function checkCart() {
    if (!window.cartStore || window.cartStore.items.length === 0) {
      alert('Tu carrito est√° vac√≠o. Ser√°s redirigido al men√∫.');
      window.location.href = '/menu';
      return false;
    }
    return true;
  }

  // Cargar zonas de delivery
  function loadDeliveryZones() {
    fetch('/data/deliveries.json')
      .then(response => response.json())
      .then(zones => {
        deliveryZones = zones;
        
        if (deliveryZoneSelect) {
          zones.forEach(zone => {
            const option = document.createElement('option');
            option.value = zone.id;
            option.textContent = `${zone.district} - S/. ${zone.price.toFixed(2)} (${zone.time})`;
            option.dataset.price = zone.price;
            option.dataset.minOrder = zone.minOrder;
            option.dataset.time = zone.time;
            option.dataset.district = zone.district;
            deliveryZoneSelect.appendChild(option);
          });
        }
      })
      .catch(error => {
        console.error('Error cargando zonas:', error);
        alert('Error al cargar zonas de delivery');
      });
  }

  // Renderizar resumen de items
  function renderSummary() {
    if (!window.cartStore || !summaryItemsEl) return;

    const items = window.cartStore.items;
    
    summaryItemsEl.innerHTML = items.map(item => `
      <div class="summary-item">
        <span class="item-name">${item.name} x${item.quantity}</span>
        <span class="item-price">S/. ${(item.price * item.quantity).toFixed(2)}</span>
      </div>
    `).join('');

    updateCostSummary();
  }

  // Actualizar resumen de costos
  function updateCostSummary() {
    if (!window.cartStore) return;

    const subtotal = window.cartStore.getTotal();
    if (costSubtotalEl) costSubtotalEl.textContent = `S/. ${subtotal.toFixed(2)}`;

    let deliveryCost = 0;
    let minOrder = 0;

    if (selectedZone) {
      deliveryCost = parseFloat(selectedZone.price) || 0;
      minOrder = parseFloat(selectedZone.minOrder) || 0;

      if (costDeliveryEl) costDeliveryEl.textContent = `S/. ${deliveryCost.toFixed(2)}`;
      if (minOrderInfoEl) {
        if (subtotal < minOrder) {
          minOrderInfoEl.textContent = `S/. ${minOrder.toFixed(2)} (‚ö†Ô∏è No alcanza)`;
          minOrderInfoEl.style.color = '#e74c3c';
        } else {
          minOrderInfoEl.textContent = `S/. ${minOrder.toFixed(2)} (‚úì Cumple)`;
          minOrderInfoEl.style.color = '#27ae60';
        }
      }
    } else {
      if (costDeliveryEl) costDeliveryEl.textContent = 'Selecciona zona';
      if (minOrderInfoEl) minOrderInfoEl.textContent = '-';
    }

    const total = subtotal + deliveryCost;
    if (costTotalEl) costTotalEl.textContent = `S/. ${total.toFixed(2)}`;
  }

  // Manejar cambio de zona
  if (deliveryZoneSelect) {
    deliveryZoneSelect.addEventListener('change', (e) => {
      const selectedOption = e.target.options[e.target.selectedIndex];
      
      if (selectedOption.value) {
        selectedZone = {
          id: selectedOption.value,
          district: selectedOption.dataset.district,
          price: parseFloat(selectedOption.dataset.price),
          minOrder: parseFloat(selectedOption.dataset.minOrder),
          time: selectedOption.dataset.time
        };
      } else {
        selectedZone = null;
      }
      
      updateCostSummary();
    });
  }

  // Enviar pedido por WhatsApp
  function sendWhatsApp() {
    if (!window.cartStore) return;

    const items = window.cartStore.items;
    const customerName = customerNameInput?.value.trim();
    const notes = notesInput?.value.trim();

    // Validaciones
    if (!customerName) {
      alert('Por favor ingresa tu nombre y apellido');
      customerNameInput?.focus();
      return;
    }

    if (!selectedZone) {
      alert('Por favor selecciona una zona de delivery');
      deliveryZoneSelect?.focus();
      return;
    }

    const subtotal = window.cartStore.getTotal();
    if (subtotal < selectedZone.minOrder) {
      alert(`El pedido m√≠nimo para ${selectedZone.district} es S/. ${selectedZone.minOrder.toFixed(2)}`);
      return;
    }

    // Construir mensaje
    let message = '*üçî PEDIDO SE√ëORA QUMARA*\n\n';
    message += `*Cliente:* ${customerName}\n`;
    message += `*Zona:* ${selectedZone.district}\n`;
    message += `*Tiempo estimado:* ${selectedZone.time}\n\n`;
    message += '*--- PRODUCTOS ---*\n';
    
    items.forEach((item, index) => {
      message += `${index + 1}. ${item.name} x${item.quantity}\n`;
      message += `   S/. ${item.price.toFixed(2)} c/u = S/. ${(item.price * item.quantity).toFixed(2)}\n`;
    });

    message += `\n*Subtotal:* S/. ${subtotal.toFixed(2)}\n`;
    message += `*Delivery:* S/. ${selectedZone.price.toFixed(2)}\n`;
    message += `*TOTAL:* S/. ${(subtotal + selectedZone.price).toFixed(2)}\n`;

    if (notes) {
      message += `\n*Notas:* ${notes}\n`;
    }

    message += '\n¬°Gracias por tu preferencia! üòä';

    // Deshabilitar bot√≥n
    if (sendWhatsAppBtn) {
      sendWhatsAppBtn.disabled = true;
      sendWhatsAppBtn.innerHTML = '<span>‚è≥</span> Enviando...';
    }

    const phoneNumber = '51967159171';
    const url = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
    
    const whatsappWindow = window.open(url, '_blank');
    
    // Restaurar bot√≥n
    setTimeout(() => {
      if (sendWhatsAppBtn) {
        sendWhatsAppBtn.disabled = false;
        sendWhatsAppBtn.innerHTML = '<span>üì±</span> Enviar Pedido por WhatsApp';
      }
    }, 1500);

    // Preguntar si limpiar carrito
    if (whatsappWindow) {
      setTimeout(() => {
        if (confirm('¬øPedido enviado exitosamente? ¬øDeseas limpiar el carrito?')) {
          window.cartStore.clear();
          window.location.href = '/';
        }
      }, 2500);
    }
  }

  // Event listeners
  sendWhatsAppBtn?.addEventListener('click', sendWhatsApp);

  // Inicializar
  if (checkCart()) {
    loadDeliveryZones();
    renderSummary();
    window.addEventListener('cart-updated', renderSummary);
  }
</script>

<style>
  .checkout-container {
    max-width: 900px;
    margin: 0 auto;
  }

  h1 {
    color: var(--primary-dark);
    margin-bottom: 2rem;
    text-align: center;
  }

  h2 {
    color: var(--primary-dark);
    font-size: 1.3rem;
    margin-bottom: 1rem;
  }

  .order-summary,
  .checkout-form,
  .cost-summary {
    background: var(--white);
    border-radius: var(--radius);
    padding: 2rem;
    margin-bottom: 1.5rem;
    box-shadow: var(--shadow);
  }

  .summary-items {
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
  }

  :global(.summary-item) {
    display: flex;
    justify-content: space-between;
    padding: 0.8rem;
    background: var(--bg-color);
    border-radius: var(--radius);
    border-left: 3px solid var(--primary-color);
  }

  :global(.summary-item .item-name) {
    font-weight: 600;
    color: var(--text-color);
  }

  :global(.summary-item .item-price) {
    font-weight: 700;
    color: var(--primary-dark);
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--text-color);
  }

  .form-group input,
  .form-group select,
  .form-group textarea {
    width: 100%;
    padding: 0.8rem;
    border: 2px solid var(--secondary-color);
    border-radius: var(--radius);
    font-size: 1rem;
    font-family: inherit;
    transition: var(--transition);
  }

  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(211, 84, 0, 0.1);
  }

  .form-group textarea {
    resize: vertical;
    min-height: 80px;
  }

  .summary-row {
    display: flex;
    justify-content: space-between;
    padding: 0.8rem 0;
    font-size: 1.1rem;
    border-bottom: 1px solid #eee;
  }

  .summary-row.total {
    border-top: 3px solid var(--primary-color);
    border-bottom: none;
    padding-top: 1.2rem;
    margin-top: 0.5rem;
    font-size: 1.4rem;
    font-weight: 700;
    color: var(--primary-dark);
  }

  .btn-whatsapp {
    width: 100%;
    background: #25D366;
    color: white;
    border: none;
    padding: 1.2rem;
    border-radius: var(--radius);
    font-size: 1.2rem;
    font-weight: 700;
    cursor: pointer;
    transition: var(--transition);
    margin-top: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .btn-whatsapp span {
    font-size: 1.5rem;
  }

  .btn-whatsapp:hover:not(:disabled) {
    background: #128C7E;
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(37, 211, 102, 0.4);
  }

  .btn-whatsapp:disabled {
    background: #a0a0a0;
    cursor: not-allowed;
    opacity: 0.7;
  }

  .btn-back {
    display: block;
    text-align: center;
    margin-top: 1rem;
    color: var(--text-light);
    text-decoration: none;
    font-weight: 600;
    transition: var(--transition);
  }

  .btn-back:hover {
    color: var(--primary-color);
  }

  @media (max-width: 768px) {
    .checkout-container {
      padding: 0;
    }

    .order-summary,
    .checkout-form,
    .cost-summary {
      padding: 1.5rem;
      margin-bottom: 1rem;
    }

    h1 {
      font-size: 1.5rem;
    }

    h2 {
      font-size: 1.2rem;
    }
  }
</style>
