---
import Layout from '../layouts/Layout.astro';
import CartStore from '../components/CartStore.astro';
---

<Layout>
  <CartStore />
  <div class="checkout-container">
    <h1>Finalizar Pedido</h1>
    
    <!-- Resumen del pedido -->
    <div class="order-summary">
      <h2>Resumen del Pedido</h2>
      <div id="summary-items" class="summary-items">
        <!-- Se llena con JS -->
      </div>
    </div>

    <!-- Formulario de datos -->
    <div class="checkout-form">
      <h2>Datos de Entrega</h2>
      <form id="checkout-form">
        <div class="form-group">
          <label for="customer-name">Nombre y Apellido *</label>
          <input 
            type="text" 
            id="customer-name" 
            name="customerName" 
            placeholder="Ej: Juan P√©rez"
            required
          />
        </div>

        <div class="form-group">
          <label for="customer-phone">N√∫mero de Celular *</label>
          <input 
            type="tel" 
            id="customer-phone" 
            name="customerPhone" 
            placeholder="Ej: 987654321"
            pattern="[0-9]{9}"
            required
          />
        </div>

        <div class="form-group">
          <label for="customer-email">Correo Electr√≥nico (opcional)</label>
          <input 
            type="email" 
            id="customer-email" 
            name="customerEmail" 
            placeholder="Ej: correo@ejemplo.com"
          />
        </div>

        <div class="form-group">
          <label for="delivery-zone">Zona de Delivery *</label>
          <select id="delivery-zone" name="deliveryZone" required>
            <option value="">Selecciona tu zona</option>
            <!-- Se llena con JS -->
          </select>
        </div>

        <div class="form-group">
          <label for="payment-method">M√©todo de Pago *</label>
          <select id="payment-method" name="paymentMethod" required>
            <option value="">Selecciona un m√©todo de pago</option>
            <option value="efectivo">Efectivo</option>
            <option value="plin">PLIN</option>
          </select>
        </div>

        <div id="plin-info" class="plin-info" style="display: none;">
          <div class="info-box">
            <p><strong>üì± N√∫mero PLIN:</strong></p>
            <p class="plin-number">967 159 171</p>
            <p class="plin-note">Por favor, realiza la transferencia y env√≠a el comprobante por WhatsApp.</p>
          </div>
        </div>

        <div class="form-group">
          <label for="notes">Notas adicionales (opcional)</label>
          <textarea 
            id="notes" 
            name="notes" 
            placeholder="Indicaciones especiales, alergias, etc."
            rows="3"
          ></textarea>
        </div>
      </form>
    </div>

    <!-- Resumen de costos -->
    <div class="cost-summary">
      <div class="summary-row">
        <span>Subtotal:</span>
        <span id="cost-subtotal">S/. 0.00</span>
      </div>
      <div class="summary-row">
        <span>Delivery:</span>
        <span id="cost-delivery">S/. 0.00</span>
      </div>
      <div class="summary-row">
        <span>Pedido M√≠nimo:</span>
        <span id="min-order-info">-</span>
      </div>
      <div class="summary-row total">
        <span>Total a Pagar:</span>
        <span id="cost-total">S/. 0.00</span>
      </div>

      <button type="button" id="send-order-btn" class="btn-order">
        <span>‚úÖ</span> Realizar Pedido
      </button>
      
      <a href="/cart" class="btn-back">‚Üê Volver al Carrito</a>
    </div>
  </div>
</Layout>

<script is:inline>
  // Helper para mostrar alertas
  function showAlert(options) {
    if (typeof Swal !== 'undefined') {
      return Swal.fire(options);
    } else {
      alert(options.text || options.title);
      return Promise.resolve({ isConfirmed: true });
    }
  }

  let deliveryZones = [];
  let selectedZone = null;

  const deliveryZoneSelect = document.getElementById('delivery-zone');
  const summaryItemsEl = document.getElementById('summary-items');
  const costSubtotalEl = document.getElementById('cost-subtotal');
  const costDeliveryEl = document.getElementById('cost-delivery');
  const freeShippingMessageEl = document.getElementById('free-shipping-message');
  const minOrderInfoEl = document.getElementById('min-order-info');
  const costTotalEl = document.getElementById('cost-total');
  const sendOrderBtn = document.getElementById('send-order-btn');
  const customerNameInput = document.getElementById('customer-name');
  const customerPhoneInput = document.getElementById('customer-phone');
  const customerEmailInput = document.getElementById('customer-email');
  const notesInput = document.getElementById('notes');
  const paymentMethodSelect = document.getElementById('payment-method');
  const plinInfoDiv = document.getElementById('plin-info');

  // Verificar que haya items en el carrito
  function checkCart() {
    if (!window.cartStore || window.cartStore.items.length === 0) {
      showAlert({
        icon: 'warning',
        title: 'Carrito vac√≠o',
        text: 'Tu carrito est√° vac√≠o. Ser√°s redirigido al men√∫.',
        confirmButtonColor: '#8B4513'
      }).then(() => {
        window.location.href = '/menu';
      });
      return false;
    }
    return true;
  }

  // Cargar zonas de delivery
  function loadDeliveryZones() {
    fetch('/data/deliveries.json')
      .then(response => response.json())
      .then(zones => {
        deliveryZones = zones;
        
        if (deliveryZoneSelect) {
          zones.forEach(zone => {
            const option = document.createElement('option');
            option.value = zone.id;
            option.textContent = `${zone.district} - S/. ${zone.price.toFixed(2)} (${zone.time})`;
            option.dataset.price = zone.price;
            option.dataset.minOrder = zone.minOrder;
            option.dataset.time = zone.time;
            option.dataset.district = zone.district;
            option.dataset.freeShipping = zone.freeShipping || 0;
            deliveryZoneSelect.appendChild(option);
          });
        }
      })
      .catch(error => {
        console.error('Error cargando zonas:', error);
        showAlert({
          icon: 'error',
          title: 'Error',
          text: 'Error al cargar zonas de delivery',
          confirmButtonColor: '#8B4513'
        });
      });
  }

  // Renderizar resumen de items
  function renderSummary() {
    if (!window.cartStore || !summaryItemsEl) return;

    const items = window.cartStore.items;
    
    summaryItemsEl.innerHTML = items.map(item => `
      <div class="summary-item">
        <span class="item-name">${item.name} x${item.quantity}</span>
        <span class="item-price">S/. ${(item.price * item.quantity).toFixed(2)}</span>
      </div>
    `).join('');

    updateCostSummary();
  }

  // Actualizar resumen de costos
  function updateCostSummary() {
    if (!window.cartStore) return;

    const subtotal = window.cartStore.getTotal();
    if (costSubtotalEl) costSubtotalEl.textContent = `S/. ${subtotal.toFixed(2)}`;

    let deliveryCost = 0;
    let minOrder = 0;
    let freeShippingAmount = 0;
    let isFreeShipping = false;

    if (selectedZone) {
      deliveryCost = parseFloat(selectedZone.price) || 0;
      minOrder = parseFloat(selectedZone.minOrder) || 0;
      freeShippingAmount = parseFloat(selectedZone.freeShipping) || 0;

      // Verificar si califica para env√≠o gratis
      if (freeShippingAmount > 0 && subtotal >= freeShippingAmount) {
        isFreeShipping = true;
        deliveryCost = 0;
      }

      if (costDeliveryEl) {
        if (isFreeShipping) {
          costDeliveryEl.innerHTML = `<span style="text-decoration: line-through; color: #999;">S/. ${selectedZone.price.toFixed(2)}</span> <span style="color: #27ae60; font-weight: 700;">¬°GRATIS!</span>`;
        } else if (freeShippingAmount > 0 && subtotal < freeShippingAmount) {
          const remaining = freeShippingAmount - subtotal;
          costDeliveryEl.innerHTML = `S/. ${deliveryCost.toFixed(2)} <small style="color: #f39c12;">(Faltan S/. ${remaining.toFixed(2)} para env√≠o gratis)</small>`;
        } else {
          costDeliveryEl.textContent = `S/. ${deliveryCost.toFixed(2)}`;
        }
      }
      
      if (minOrderInfoEl) {
        if (subtotal < minOrder) {
          minOrderInfoEl.textContent = `S/. ${minOrder.toFixed(2)} (‚ö†Ô∏è No alcanza)`;
          minOrderInfoEl.style.color = '#e74c3c';
        } else {
          minOrderInfoEl.textContent = `S/. ${minOrder.toFixed(2)} (‚úì Cumple)`;
          minOrderInfoEl.style.color = '#27ae60';
        }
      }
    } else {
      if (costDeliveryEl) costDeliveryEl.textContent = 'Selecciona zona';
      if (minOrderInfoEl) minOrderInfoEl.textContent = '-';
    }

    const total = subtotal + deliveryCost;
    if (costTotalEl) costTotalEl.textContent = `S/. ${total.toFixed(2)}`;
  }

  // Manejar cambio de zona
  if (deliveryZoneSelect) {
    deliveryZoneSelect.addEventListener('change', (e) => {
      const selectedOption = e.target.options[e.target.selectedIndex];
      
      if (selectedOption.value) {
        selectedZone = {
          id: selectedOption.value,
          district: selectedOption.dataset.district,
          price: parseFloat(selectedOption.dataset.price),
          minOrder: parseFloat(selectedOption.dataset.minOrder),
          time: selectedOption.dataset.time,
          freeShipping: parseFloat(selectedOption.dataset.freeShipping) || 0
        };
      } else {
        selectedZone = null;
      }
      
      updateCostSummary();
    });
  }

  // Manejar cambio de m√©todo de pago
  if (paymentMethodSelect) {
    paymentMethodSelect.addEventListener('change', (e) => {
      const selectedMethod = e.target.value;
      if (plinInfoDiv) {
        plinInfoDiv.style.display = selectedMethod === 'plin' ? 'block' : 'none';
      }
    });
  }

  // Realizar pedido
  function realizarPedido() {
    if (!window.cartStore) return;

    const items = window.cartStore.items;
    const customerName = customerNameInput?.value.trim();
    const customerPhone = customerPhoneInput?.value.trim();
    const customerEmail = customerEmailInput?.value.trim();
    const notes = notesInput?.value.trim();

    // Validaciones
    if (!customerName) {
      showAlert({
        icon: 'warning',
        title: 'Nombre requerido',
        text: 'Por favor ingresa tu nombre y apellido',
        confirmButtonColor: '#8B4513'
      });
      customerNameInput?.focus();
      return;
    }

    if (!customerPhone) {
      showAlert({
        icon: 'warning',
        title: 'Tel√©fono requerido',
        text: 'Por favor ingresa tu n√∫mero de celular',
        confirmButtonColor: '#8B4513'
      });
      customerPhoneInput?.focus();
      return;
    }

    if (customerPhone.length !== 9 || !/^[0-9]+$/.test(customerPhone)) {
      showAlert({
        icon: 'warning',
        title: 'Tel√©fono inv√°lido',
        text: 'El n√∫mero debe tener 9 d√≠gitos',
        confirmButtonColor: '#8B4513'
      });
      customerPhoneInput?.focus();
      return;
    }

    if (!selectedZone) {
      showAlert({
        icon: 'warning',
        title: 'Zona requerida',
        text: 'Por favor selecciona una zona de delivery',
        confirmButtonColor: '#8B4513'
      });
      deliveryZoneSelect?.focus();
      return;
    }

    const paymentMethod = paymentMethodSelect?.value;
    if (!paymentMethod) {
      showAlert({
        icon: 'warning',
        title: 'M√©todo de pago requerido',
        text: 'Por favor selecciona un m√©todo de pago',
        confirmButtonColor: '#8B4513'
      });
      paymentMethodSelect?.focus();
      return;
    }

    const subtotal = window.cartStore.getTotal();
    if (subtotal < selectedZone.minOrder) {
      showAlert({
        icon: 'info',
        title: 'Pedido m√≠nimo no alcanzado',
        text: `El pedido m√≠nimo para ${selectedZone.district} es S/. ${selectedZone.minOrder.toFixed(2)}. Tu pedido actual es S/. ${subtotal.toFixed(2)}`,
        confirmButtonColor: '#8B4513'
      });
      return;
    }

    // Construir mensaje
    let message = '*üçî PEDIDO SE√ëORA QUMARA*\n\n';
    message += `*Cliente:* ${customerName}\n`;
    message += `*Tel√©fono:* ${customerPhone}\n`;
    if (customerEmail) {
      message += `*Email:* ${customerEmail}\n`;
    }
    message += `*Zona:* ${selectedZone.district}\n`;
    message += `*Tiempo estimado:* ${selectedZone.time}\n`;
    message += `*M√©todo de Pago:* ${paymentMethod === 'efectivo' ? 'Efectivo üíµ' : 'PLIN üì±'}\n`;
    if (paymentMethod === 'plin') {
      message += `*N√∫mero PLIN:* 967 159 171\n`;
    }
    message += '\n';
    message += '*--- PRODUCTOS ---*\n';
    
    items.forEach((item, index) => {
      message += `${index + 1}. ${item.name} x${item.quantity}\n`;
      message += `   S/. ${item.price.toFixed(2)} c/u = S/. ${(item.price * item.quantity).toFixed(2)}\n`;
    });

    // Calcular delivery final (con env√≠o gratis si aplica)
    const freeShippingAmount = parseFloat(selectedZone.freeShipping) || 0;
    const finalDeliveryCost = (freeShippingAmount > 0 && subtotal >= freeShippingAmount) ? 0 : selectedZone.price;
    const isFreeShipping = freeShippingAmount > 0 && subtotal >= freeShippingAmount;

    message += `\n*Subtotal:* S/. ${subtotal.toFixed(2)}\n`;
    if (isFreeShipping) {
      message += `*Delivery:* ~~S/. ${selectedZone.price.toFixed(2)}~~ ¬°GRATIS!\n`;
    } else {
      message += `*Delivery:* S/. ${finalDeliveryCost.toFixed(2)}\n`;
    }
    message += `*TOTAL:* S/. ${(subtotal + finalDeliveryCost).toFixed(2)}\n`;

    if (notes) {
      message += `\n*Notas:* ${notes}\n`;
    }

    message += '\n¬°Gracias por tu preferencia! üòä';

    // Deshabilitar bot√≥n
    if (sendOrderBtn) {
      sendOrderBtn.disabled = true;
      sendOrderBtn.innerHTML = '<span>‚è≥</span> Procesando...';
    }

    // Enviar notificaci√≥n a Telegram
    const telegramBotToken = '8350609465:AAF5jY2py4ujV123KzfSNOOuHgKU0EsEGdA';
    const telegramChatId = '6048503687';
    const telegramUrl = `https://api.telegram.org/bot${telegramBotToken}/sendMessage`;
    
    fetch(telegramUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        chat_id: telegramChatId,
        text: message,
        parse_mode: 'Markdown'
      })
    }).then(() => {
      // Guardar datos del pedido en sessionStorage para la p√°gina de √©xito
      sessionStorage.setItem('orderMessage', message);
      sessionStorage.setItem('customerPhone', customerPhone);
      
      // Limpiar carrito
      window.cartStore.clear();
      
      // Redirigir a p√°gina de √©xito
      window.location.href = '/success';
    }).catch(err => {
      console.error('Error enviando a Telegram:', err);
      
      // A√∫n as√≠, redirigir a p√°gina de √©xito
      sessionStorage.setItem('orderMessage', message);
      sessionStorage.setItem('customerPhone', customerPhone);
      window.cartStore.clear();
      window.location.href = '/success';
    });
  }

  // Event listeners
  sendOrderBtn?.addEventListener('click', realizarPedido);

  // Inicializar
  if (checkCart()) {
    loadDeliveryZones();
    renderSummary();
    window.addEventListener('cart-updated', renderSummary);
  }
</script>

<style>
  .checkout-container {
    max-width: 900px;
    margin: 0 auto;
  }

  h1 {
    color: var(--primary-dark);
    margin-bottom: 2rem;
    text-align: center;
  }

  h2 {
    color: var(--primary-dark);
    font-size: 1.3rem;
    margin-bottom: 1rem;
  }

  .order-summary,
  .checkout-form,
  .cost-summary {
    background: var(--white);
    border-radius: var(--radius);
    padding: 2rem;
    margin-bottom: 1.5rem;
    box-shadow: var(--shadow);
  }

  .summary-items {
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
  }

  :global(.summary-item) {
    display: flex;
    justify-content: space-between;
    padding: 0.8rem;
    background: var(--bg-color);
    border-radius: var(--radius);
    border-left: 3px solid var(--primary-color);
  }

  :global(.summary-item .item-name) {
    font-weight: 600;
    color: var(--text-color);
  }

  :global(.summary-item .item-price) {
    font-weight: 700;
    color: var(--primary-dark);
  }

  .form-group {
    margin-bottom: 1.5rem;
  }

  .form-group label {
    display: block;
    font-weight: 600;
    margin-bottom: 0.5rem;
    color: var(--text-color);
  }

  .form-group input,
  .form-group select,
  .form-group textarea {
    width: 100%;
    padding: 0.8rem;
    border: 2px solid var(--secondary-color);
    border-radius: var(--radius);
    font-size: 1rem;
    font-family: inherit;
    transition: var(--transition);
  }

  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(211, 84, 0, 0.1);
  }

  .form-group textarea {
    resize: vertical;
    min-height: 80px;
  }

  .plin-info {
    margin-top: 1rem;
    margin-bottom: 1.5rem;
  }

  .info-box {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1.5rem;
    border-radius: var(--radius);
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
  }

  .info-box p {
    margin: 0.5rem 0;
  }

  .plin-number {
    font-size: 1.8rem;
    font-weight: 700;
    letter-spacing: 2px;
    text-align: center;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    margin: 1rem 0;
  }

  .plin-note {
    font-size: 0.9rem;
    text-align: center;
    opacity: 0.95;
    margin-top: 1rem;
  }

  .summary-row {
    display: flex;
    justify-content: space-between;
    padding: 0.8rem 0;
    font-size: 1.1rem;
    border-bottom: 1px solid #eee;
  }

  .summary-row.total {
    border-top: 3px solid var(--primary-color);
    border-bottom: none;
    padding-top: 1.2rem;
    margin-top: 0.5rem;
    font-size: 1.4rem;
    font-weight: 700;
    color: var(--primary-dark);
  }

  .btn-order {
    width: 100%;
    background: var(--primary-color);
    color: white;
    border: none;
    padding: 1.2rem;
    border-radius: var(--radius);
    font-size: 1.2rem;
    font-weight: 700;
    cursor: pointer;
    transition: var(--transition);
    margin-top: 1.5rem;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
  }

  .btn-order span {
    font-size: 1.5rem;
  }

  .btn-order:hover:not(:disabled) {
    background: var(--primary-dark);
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(211, 84, 0, 0.4);
  }

  .btn-order:disabled {
    background: #a0a0a0;
    cursor: not-allowed;
    opacity: 0.7;
  }

  .btn-back {
    display: block;
    text-align: center;
    margin-top: 1rem;
    color: var(--text-light);
    text-decoration: none;
    font-weight: 600;
    transition: var(--transition);
  }

  .btn-back:hover {
    color: var(--primary-color);
  }

  @media (max-width: 768px) {
    .checkout-container {
      padding: 0;
    }

    .order-summary,
    .checkout-form,
    .cost-summary {
      padding: 1.5rem;
      margin-bottom: 1rem;
    }

    h1 {
      font-size: 1.5rem;
    }

    h2 {
      font-size: 1.2rem;
    }
  }
</style>
